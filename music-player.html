<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="originalTitle">éŸ³æ¥½ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ | ä¾¿åˆ©ãƒ„ãƒ¼ãƒ«ã¾ã¨ã‚</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Helvetica Neue', 'Arial', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* ãƒãƒ¼ã‚¿ãƒ«ã¨åˆã‚ã›ãŸèƒŒæ™¯è‰² */
        body {
            background-color: #f4f7f9;
            color: #333;
        }
        #audioPlayer:not([src]) {
            display: none;
        }
        .move-btn {
            @apply p-1.5 rounded-full text-xs text-gray-500 bg-gray-100 hover:bg-gray-200 disabled:opacity-30 disabled:cursor-not-allowed transition duration-150;
            line-height: 1;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .playing-item {
            @apply bg-blue-50 border-blue-400 ring-1 ring-blue-400;
        }
        /* ã‚«ãƒ¼ãƒ‰ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’çµ±ä¸€ */
        .main-card {
            background: #ffffff;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="p-4 md:p-8 font-sans">

    <div class="max-w-md mx-auto mb-4">
        <a href="index.html" class="text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center">
            <span class="mr-1">â†</span> ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹
        </a>
    </div>

    <div class="max-w-md mx-auto p-6 main-card space-y-5">
        
        <div class="text-center border-b pb-4">
            <span class="text-4xl mb-2 block">ğŸµ</span>
            <h1 class="text-2xl font-bold text-gray-800">éŸ³æ¥½ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</h1>
            <p class="text-xs text-gray-500 mt-2">
                ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã€å†ç”Ÿãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚
            </p>
        </div>
        
        <div class="space-y-2">
            <label class="block text-sm font-semibold text-gray-700" for="fileInput">
                éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
            </label>
            <input type="file" id="fileInput" multiple accept=".mp3,.wav,.ogg,.m4a,audio/*"
                   class="block w-full text-xs text-gray-500
                   file:mr-2 file:py-2 file:px-4
                   file:rounded-full file:border-0
                   file:text-xs file:font-semibold
                   file:bg-blue-50 file:text-blue-700
                   hover:file:bg-blue-100 cursor-pointer">
        </div>

        <div class="flex flex-col space-y-3">
            <div class="flex items-center space-x-2">
                <label for="playMode" class="text-sm font-medium text-gray-700 whitespace-nowrap">å†ç”Ÿãƒ¢ãƒ¼ãƒ‰:</label>
                <select id="playMode" class="py-2 px-3 border border-gray-300 bg-white rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none w-full">
                    <option value="sequential">ä¸¦ã³æ›¿ãˆé †</option>
                    <option value="random">å®Œå…¨ãƒ©ãƒ³ãƒ€ãƒ </option>
                </select>
            </div>
            
            <div class="flex space-x-2">
                <button id="playButton" disabled
                    class="flex-1 py-3 px-4 rounded-lg text-sm font-bold text-white bg-blue-600 hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition duration-150 shadow-md">
                    <span id="playButtonText">é€£ç¶šå†ç”Ÿé–‹å§‹</span>
                </button>
                <button id="stopButton" disabled
                    class="py-3 px-4 rounded-lg text-sm font-bold text-gray-700 bg-gray-200 hover:bg-gray-300 disabled:opacity-50 transition duration-150">
                    åœæ­¢
                </button>
            </div>
        </div>

        <div id="status" class="text-xs font-medium text-center p-3 rounded-lg bg-blue-50 text-blue-700 border border-blue-100">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>

        <audio id="audioPlayer" controls class="w-full"></audio>

        <div class="sort-buttons flex justify-between items-center pt-2">
            <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Playlist Control</span>
            <div class="flex space-x-1">
                <button id="sortAlpha" class="py-1 px-2 border border-gray-200 rounded text-[10px] font-bold text-gray-600 bg-white hover:bg-gray-50">
                    åå‰é †
                </button>
                <button id="sortOriginal" class="py-1 px-2 border border-gray-200 rounded text-[10px] font-bold text-gray-600 bg-white hover:bg-gray-50">
                    åˆæœŸé †
                </button>
            </div>
        </div>

        <div id="playlistDiv" class="border border-gray-100 rounded-xl p-4 bg-gray-50/50">
            <ul id="playlist-ul" class="space-y-2 max-h-60 overflow-y-auto pr-1">
                </ul>
        </div>
    </div>

    <script>
        /* --- ä»¥ä¸‹ã€å…ƒã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ãã®ã¾ã¾ç¶­æŒ --- */
        const fileInput = document.getElementById('fileInput');
        const playButton = document.getElementById('playButton');
        const stopButton = document.getElementById('stopButton');
        const playModeSelect = document.getElementById('playMode');
        const sortAlphaButton = document.getElementById('sortAlpha');
        const sortOriginalButton = document.getElementById('sortOriginal');
        const status = document.getElementById('status');
        const audioPlayer = document.getElementById('audioPlayer');
        const playlistUl = document.getElementById('playlist-ul');
        const playButtonText = document.getElementById('playButtonText');
        const originalTitleElement = document.getElementById('originalTitle');

        let audioFiles = []; 
        let originalOrder = []; 
        let playbackList = []; 
        let currentIndex = 0;
        let isPlaying = false;
        let playMode = 'sequential'; 
        const appTitle = originalTitleElement.textContent;

        fileInput.addEventListener('change', function(event) {
            audioFiles = Array.from(event.target.files);
            originalOrder = [...audioFiles];
            
            if (audioFiles.length > 0) {
                playButton.disabled = false;
                status.textContent = `${audioFiles.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¾ã—ãŸã€‚`;
                updatePlaylist();
                playButtonText.textContent = 'é€£ç¶šå†ç”Ÿé–‹å§‹';
            } else {
                resetState();
            }
        });

        function resetState() {
            isPlaying = false;
            currentIndex = 0;
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            if (audioPlayer.src) {
                URL.revokeObjectURL(audioPlayer.src);
                audioPlayer.removeAttribute('src');
            }
            document.title = appTitle;

            playButton.disabled = audioFiles.length === 0; 
            stopButton.disabled = true;
            status.textContent = audioFiles.length > 0 ? `${audioFiles.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸã€‚` : 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
            if (audioFiles.length === 0) {
                playlistUl.innerHTML = '';
            } else {
                updatePlaylist();
            }
            playButtonText.textContent = 'é€£ç¶šå†ç”Ÿé–‹å§‹';
        }

        function moveItem(fromIndex, toIndex) {
            if (fromIndex < 0 || fromIndex >= audioFiles.length || toIndex < 0 || toIndex >= audioFiles.length) {
                return;
            }
            [audioFiles[fromIndex], audioFiles[toIndex]] = [audioFiles[toIndex], audioFiles[fromIndex]];
            
            updatePlaylist();
            status.textContent = 'é †åºã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚';
        }
        
        function updatePlaylist() {
            playlistUl.innerHTML = '';
            audioFiles.forEach((file, index) => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center py-2 px-3 rounded-lg border border-transparent shadow-sm transition duration-100 bg-white';
                li.dataset.index = index;
                
                if (isPlaying && playbackList[currentIndex] === file) {
                    li.classList.add('playing-item');
                }
                
                const fileInfo = document.createElement('div');
                fileInfo.className = 'flex items-center w-full min-w-0';
                fileInfo.innerHTML = `<span class="text-xs font-bold text-blue-400 mr-2 w-4">${index + 1}</span>
                                      <span class="truncate text-sm font-medium text-gray-700">${file.name}</span>`;

                const moveControls = document.createElement('div');
                moveControls.className = 'flex items-center space-x-1 ml-2 flex-shrink-0';
                
                const moveUpBtn = document.createElement('button');
                moveUpBtn.className = 'move-btn';
                moveUpBtn.innerHTML = 'â†‘';
                moveUpBtn.disabled = index === 0;
                moveUpBtn.addEventListener('click', (e) => { e.preventDefault(); moveItem(index, index - 1); });
                
                const moveDownBtn = document.createElement('button');
                moveDownBtn.className = 'move-btn';
                moveDownBtn.innerHTML = 'â†“';
                moveDownBtn.disabled = index === audioFiles.length - 1;
                moveDownBtn.addEventListener('click', (e) => { e.preventDefault(); moveItem(index, index + 1); });

                moveControls.appendChild(moveUpBtn);
                moveControls.appendChild(moveDownBtn);

                li.appendChild(fileInfo);
                li.appendChild(moveControls);
                
                playlistUl.appendChild(li);
            });
        }
        
        sortAlphaButton.addEventListener('click', function() {
            if (audioFiles.length === 0) return;
            audioFiles.sort((a, b) => a.name.localeCompare(b.name, 'ja')); 
            updatePlaylist();
            status.textContent = 'åå‰é †ã«ã‚½ãƒ¼ãƒˆã—ã¾ã—ãŸã€‚';
        });

        sortOriginalButton.addEventListener('click', function() {
            if (originalOrder.length === 0) return;
            const reorderedFiles = originalOrder.map(originalFile => 
                audioFiles.find(currentFile => currentFile === originalFile)
            ).filter(file => file);

            audioFiles = reorderedFiles;
            updatePlaylist();
            status.textContent = 'å…ƒã®é †åºã«æˆ»ã—ã¾ã—ãŸã€‚';
        });

        playModeSelect.addEventListener('change', function() {
            playMode = this.value;
            status.textContent = `å†ç”Ÿãƒ¢ãƒ¼ãƒ‰: ${playMode === 'sequential' ? 'ä¸¦ã³æ›¿ãˆé †' : 'å®Œå…¨ãƒ©ãƒ³ãƒ€ãƒ '}`;
        });

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function playNext() {
            if (!isPlaying || playbackList.length === 0) return;

            const selectedFile = playbackList[currentIndex];
            const audioUrl = URL.createObjectURL(selectedFile);
            
            if (audioPlayer.src) URL.revokeObjectURL(audioPlayer.src);
            
            audioPlayer.src = audioUrl;

            audioPlayer.play().then(() => {
                const modeText = playMode === 'sequential' ? 'é †åº' : 'ãƒ©ãƒ³ãƒ€ãƒ ';
                status.textContent = `å†ç”Ÿä¸­: ${selectedFile.name} (${currentIndex + 1}/${playbackList.length})`;
                playButtonText.textContent = 'å†ç”Ÿä¸­...';
                document.title = `â–¶ ${selectedFile.name}`;
                updatePlaylist();
            }).catch(error => {
                console.error('å†ç”Ÿã‚¨ãƒ©ãƒ¼:', error);
                status.textContent = 'è‡ªå‹•å†ç”ŸãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚';
                handleTrackEnd(); 
            });
        }
        
        function handleTrackEnd() {
            if (!isPlaying) return;
            currentIndex++;
            if (currentIndex >= playbackList.length) {
                currentIndex = 0;
                if (playMode === 'random') {
                    playbackList = shuffleArray([...audioFiles]);
                }
            }
            if (isPlaying) {
                playNext();
            } else {
                resetState();
            }
        }
        
        audioPlayer.addEventListener('pause', function() {
            if (isPlaying && playbackList[currentIndex]) {
                document.title = `â¸ ${playbackList[currentIndex].name}`;
            }
        });

        audioPlayer.addEventListener('play', function() {
            if (isPlaying && playbackList[currentIndex]) {
                document.title = `â–¶ ${playbackList[currentIndex].name}`;
            }
        });

        audioPlayer.addEventListener('ended', handleTrackEnd);

        playButton.addEventListener('click', function() {
            if (audioFiles.length === 0) return;
            if (playMode === 'sequential') {
                playbackList = [...audioFiles]; 
            } else {
                playbackList = shuffleArray([...audioFiles]);
            }
            currentIndex = 0;
            isPlaying = true;
            playButton.disabled = true;
            stopButton.disabled = false;
            playNext();
        });

        stopButton.addEventListener('click', function() {
            resetState();
            status.textContent = 'åœæ­¢ã—ã¾ã—ãŸã€‚';
        });

        window.addEventListener('beforeunload', function() {
            if (audioPlayer.src) {
                URL.revokeObjectURL(audioPlayer.src);
            }
        });
        
        updatePlaylist();
        resetState();
    </script>
</body>
</html>
