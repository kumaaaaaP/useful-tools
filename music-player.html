<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="originalTitle">éŸ³æ¥½ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ | ä¾¿åˆ©ãƒ„ãƒ¼ãƒ«ã¾ã¨ã‚</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4a90e2',
                        bgSecondary: '#f4f7f9',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f4f7f9;
        }
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        #playlist-ul::-webkit-scrollbar {
            width: 6px;
        }
        #playlist-ul::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        #playlist-ul::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 10px;
        }
        /* å†ç”Ÿä¸­ã‚¢ã‚¤ãƒ†ãƒ ã®å¼·èª¿ */
        .playing-item {
            background-color: #eef6ff !important;
            border-color: #4a90e2 !important;
            box-shadow: 0 2px 4px rgba(74, 144, 226, 0.2);
        }
        /* éè¡¨ç¤ºè¨­å®š */
        #audioPlayer:not([src]) {
            display: none;
        }
        .move-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div class="max-w-2xl mx-auto space-y-6">
        
        <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-gray-100">
            <a href="index.html" class="text-primary hover:underline text-sm font-bold flex items-center">
                â† ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
            </a>
            <h1 class="text-xl font-extrabold text-gray-800">ğŸµ éŸ³æ¥½ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</h1>
        </div>

        <div class="bg-white rounded-2xl shadow-md p-6 border border-gray-100 space-y-5">
            
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
                <input type="file" id="fileInput" multiple accept=".mp3,.wav,.ogg,.m4a,audio/*"
                       class="block w-full text-sm text-gray-500
                       file:mr-4 file:py-2 file:px-4
                       file:rounded-full file:border-0
                       file:text-sm file:font-semibold
                       file:bg-blue-50 file:text-primary
                       hover:file:bg-blue-100 cursor-pointer">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="space-y-2">
                    <label for="playMode" class="text-sm font-medium text-gray-600">å†ç”Ÿãƒ¢ãƒ¼ãƒ‰</label>
                    <select id="playMode" class="w-full p-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-primary focus:outline-none">
                        <option value="sequential">ä¸¦ã³æ›¿ãˆé †</option>
                        <option value="random">å®Œå…¨ãƒ©ãƒ³ãƒ€ãƒ </option>
                    </select>
                </div>
                <div class="flex items-end space-x-2">
                    <button id="playButton" disabled class="flex-1 bg-primary text-white py-2 rounded-lg font-bold hover:bg-blue-600 disabled:bg-gray-300 transition-all">
                        <span id="playButtonText">å†ç”Ÿé–‹å§‹</span>
                    </button>
                    <button id="stopButton" disabled class="px-4 bg-gray-100 text-gray-600 py-2 rounded-lg font-bold hover:bg-gray-200 disabled:opacity-50">
                        åœæ­¢
                    </button>
                </div>
            </div>

            <div id="status" class="text-xs font-medium text-center py-2 px-4 rounded-full bg-blue-50 text-primary border border-blue-100">
                ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
            </div>

            <audio id="audioPlayer" controls class="w-full h-10"></audio>
        </div>

        <div class="bg-white rounded-2xl shadow-md p-6 border border-gray-100">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-gray-800 flex items-center">
                    <span class="mr-2">ğŸ“‹</span> ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ
                </h3>
                <div class="flex space-x-2">
                    <button id="sortAlpha" class="text-[10px] px-2 py-1 bg-gray-50 border border-gray-200 rounded text-gray-600 hover:bg-gray-100">åå‰é †</button>
                    <button id="sortOriginal" class="text-[10px] px-2 py-1 bg-gray-50 border border-gray-200 rounded text-gray-600 hover:bg-gray-100">å…ƒã®é †</button>
                </div>
            </div>
            
            <ul id="playlist-ul" class="space-y-2 max-h-64 overflow-y-auto pr-1">
                </ul>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const playButton = document.getElementById('playButton');
        const stopButton = document.getElementById('stopButton');
        const playModeSelect = document.getElementById('playMode');
        const sortAlphaButton = document.getElementById('sortAlpha');
        const sortOriginalButton = document.getElementById('sortOriginal');
        const status = document.getElementById('status');
        const audioPlayer = document.getElementById('audioPlayer');
        const playlistUl = document.getElementById('playlist-ul');
        const playButtonText = document.getElementById('playButtonText');
        const originalTitleElement = document.getElementById('originalTitle');

        let audioFiles = []; 
        let originalOrder = []; 
        let playbackList = []; 
        let currentIndex = 0;
        let isPlaying = false;
        let playMode = 'sequential'; 
        const appTitle = originalTitleElement.textContent;

        fileInput.addEventListener('change', function(event) {
            audioFiles = Array.from(event.target.files);
            originalOrder = [...audioFiles];
            if (audioFiles.length > 0) {
                playButton.disabled = false;
                status.textContent = `${audioFiles.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¾ã—ãŸã€‚`;
                updatePlaylist();
                playButtonText.textContent = 'é€£ç¶šå†ç”Ÿé–‹å§‹';
            } else {
                resetState();
            }
        });

        function resetState() {
            isPlaying = false;
            currentIndex = 0;
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            if (audioPlayer.src) {
                URL.revokeObjectURL(audioPlayer.src);
                audioPlayer.removeAttribute('src');
            }
            document.title = appTitle;
            playButton.disabled = audioFiles.length === 0; 
            stopButton.disabled = true;
            status.textContent = audioFiles.length > 0 ? `${audioFiles.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒæº–å‚™å®Œäº†ã€‚` : 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
            if (audioFiles.length === 0) {
                playlistUl.innerHTML = '<p class="text-center text-gray-400 text-sm py-4">ãƒªã‚¹ãƒˆãŒç©ºã§ã™</p>';
            } else {
                updatePlaylist();
            }
            playButtonText.textContent = 'é€£ç¶šå†ç”Ÿé–‹å§‹';
        }

        function moveItem(fromIndex, toIndex) {
            if (fromIndex < 0 || fromIndex >= audioFiles.length || toIndex < 0 || toIndex >= audioFiles.length) return;
            [audioFiles[fromIndex], audioFiles[toIndex]] = [audioFiles[toIndex], audioFiles[fromIndex]];
            updatePlaylist();
        }
        
        function updatePlaylist() {
            playlistUl.innerHTML = '';
            if (audioFiles.length === 0) {
                playlistUl.innerHTML = '<p class="text-center text-gray-400 text-sm py-4">ãƒªã‚¹ãƒˆãŒç©ºã§ã™</p>';
                return;
            }
            audioFiles.forEach((file, index) => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-3 rounded-xl border border-gray-100 bg-gray-50 transition-all';
                
                if (isPlaying && playbackList[currentIndex] === file) {
                    li.classList.add('playing-item');
                }
                
                li.innerHTML = `
                    <div class="flex items-center min-w-0 flex-1">
                        <span class="text-xs font-bold text-gray-400 w-6">${index + 1}</span>
                        <span class="truncate text-sm font-semibold text-gray-700">${file.name}</span>
                    </div>
                    <div class="flex items-center space-x-1 ml-2">
                        <button onclick="event.stopPropagation(); moveItem(${index}, ${index - 1})" ${index === 0 ? 'disabled' : ''} class="move-btn text-gray-400 hover:text-primary disabled:opacity-20 text-xs bg-white rounded-full shadow-sm">â†‘</button>
                        <button onclick="event.stopPropagation(); moveItem(${index}, ${index + 1})" ${index === audioFiles.length - 1 ? 'disabled' : ''} class="move-btn text-gray-400 hover:text-primary disabled:opacity-20 text-xs bg-white rounded-full shadow-sm">â†“</button>
                    </div>
                `;
                playlistUl.appendChild(li);
            });
        }
        
        sortAlphaButton.addEventListener('click', () => {
            audioFiles.sort((a, b) => a.name.localeCompare(b.name, 'ja'));
            updatePlaylist();
        });

        sortOriginalButton.addEventListener('click', () => {
            audioFiles = [...originalOrder];
            updatePlaylist();
        });

        playModeSelect.addEventListener('change', function() {
            playMode = this.value;
        });

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function playNext() {
            if (!isPlaying || playbackList.length === 0) return;
            const selectedFile = playbackList[currentIndex];
            const audioUrl = URL.createObjectURL(selectedFile);
            if (audioPlayer.src) URL.revokeObjectURL(audioPlayer.src);
            audioPlayer.src = audioUrl;
            audioPlayer.play().then(() => {
                status.textContent = `å†ç”Ÿä¸­: ${selectedFile.name} (${currentIndex + 1}/${playbackList.length})`;
                playButtonText.textContent = 'å†ç”Ÿä¸­...';
                document.title = `â–¶ ${selectedFile.name}`;
                updatePlaylist();
            }).catch(error => {
                handleTrackEnd(); 
            });
        }
        
        function handleTrackEnd() {
            if (!isPlaying) return;
            currentIndex++;
            if (currentIndex >= playbackList.length) {
                currentIndex = 0;
                if (playMode === 'random') playbackList = shuffleArray([...audioFiles]);
            }
            playNext();
        }
        
        audioPlayer.addEventListener('ended', handleTrackEnd);

        playButton.addEventListener('click', function() {
            if (audioFiles.length === 0) return;
            playbackList = playMode === 'sequential' ? [...audioFiles] : shuffleArray([...audioFiles]);
            currentIndex = 0;
            isPlaying = true;
            playButton.disabled = true;
            stopButton.disabled = false;
            playNext();
        });

        stopButton.addEventListener('click', () => {
            resetState();
            status.textContent = 'å†ç”Ÿã‚’åœæ­¢ã—ã¾ã—ãŸã€‚';
        });

        window.addEventListener('beforeunload', () => {
            if (audioPlayer.src) URL.revokeObjectURL(audioPlayer.src);
        });
        
        updatePlaylist();
    </script>
</body>
</html>
