<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF ç”»åƒå¤‰æ› | ä¾¿åˆ©ãƒ„ãƒ¼ãƒ«ã¾ã¨ã‚</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Helvetica Neue', 'Arial', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            background-color: #f4f7f9;
            color: #333;
        }
        .main-card {
            background: #ffffff;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .drag-active {
            border-color: #4a90e2;
            background-color: #eff6ff;
        }
        canvas {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4a90e2;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8 font-sans">

    <div class="max-w-5xl mx-auto mb-4">
        <a href="index.html" class="text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center">
            <span class="mr-1">â†</span> ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹
        </a>
    </div>

    <main class="max-w-5xl mx-auto space-y-6">
        
        <div class="main-card p-6 md:p-8">
            <div class="text-center border-b pb-6 mb-6">
                <span class="text-4xl mb-2 block">ğŸ“„</span>
                <h1 class="text-2xl font-bold text-gray-800">PDF ç”»åƒå¤‰æ›ãƒ„ãƒ¼ãƒ«</h1>
                <p class="text-xs text-gray-500 mt-2">ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§å®‰å…¨ã«PDFã‚’ç”»åƒã«å¤‰æ›ãƒ»ä¿å­˜ã—ã¾ã™</p>
            </div>

            <div id="drop-zone" class="border-2 border-dashed border-gray-200 rounded-xl p-8 text-center transition-all cursor-pointer hover:bg-gray-50 flex flex-col items-center justify-center min-h-[180px]">
                <input type="file" id="file-input" class="hidden" accept="application/pdf">
                <div class="mb-3 bg-blue-50 p-3 rounded-full text-blue-500">
                    <i data-lucide="upload-cloud" class="w-8 h-8"></i>
                </div>
                <h3 class="text-sm font-bold mb-1">PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—</h3>
                <p class="text-[11px] text-gray-400 mb-4">ã¾ãŸã¯ã€ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</p>
                <button class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-full text-xs font-bold transition-all shadow-sm">
                    ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                </button>
            </div>

            <div id="settings-area" class="mt-6 border-t pt-6 hidden">
                <div class="flex flex-wrap gap-4 mb-6">
                    <div class="flex flex-col gap-1">
                        <label class="font-bold text-[11px] text-gray-500 uppercase tracking-wider">ä¿å­˜å½¢å¼</label>
                        <select id="format-select" class="bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="image/jpeg">JPEG (å†™çœŸå‘ã‘)</option>
                            <option value="image/png">PNG (ãƒ†ã‚­ã‚¹ãƒˆå‘ã‘)</option>
                        </select>
                    </div>
                    <div class="flex flex-col gap-1">
                        <label class="font-bold text-[11px] text-gray-500 uppercase tracking-wider">ç”»è³ªï¼ˆå€ç‡ï¼‰</label>
                        <select id="scale-select" class="bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="1">1x (æ¨™æº–)</option>
                            <option value="1.5">1.5x (é«˜ç”»è³ª)</option>
                            <option value="2" selected>2.0x (è¶…é«˜ç”»è³ª)</option>
                        </select>
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row gap-4 items-center justify-between bg-blue-50 p-4 rounded-xl">
                    <div class="flex items-center gap-3">
                        <i data-lucide="files" class="w-5 h-5 text-blue-500"></i>
                        <span id="page-count-info" class="text-sm font-bold text-blue-700"></span>
                    </div>
                    <button id="download-all-btn" class="w-full sm:w-auto flex items-center justify-center gap-2 bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg text-sm font-bold transition-all shadow-md disabled:opacity-50" disabled>
                        <i data-lucide="download-cloud" class="w-4 h-4"></i>
                        ã™ã¹ã¦ZIPã§ä¿å­˜
                    </button>
                </div>
            </div>
        </div>

        <div id="status-container" class="hidden main-card p-10 text-center">
            <div class="inline-block loader mb-4"></div>
            <p id="status-text" class="text-sm font-medium text-gray-600">PDFã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>

        <div id="results-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden pb-10">
            </div>

    </main>

    <div id="message-modal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 shadow-2xl w-full max-w-xs text-center">
            <h4 id="modal-title" class="text-lg font-bold mb-2 text-gray-800"></h4>
            <p id="modal-body" class="text-xs text-gray-500 mb-6"></p>
            <button id="modal-close-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-xl text-sm font-bold transition-all">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script>
        // ãƒ­ã‚¸ãƒƒã‚¯ã¯å…ƒã®ã‚³ãƒ¼ãƒ‰ã‚’å®Œå…¨ã«ç¶­æŒ
        let pdfDocument = null;
        let originalFileName = '';
        const canvasMap = new Map();

        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const settingsArea = document.getElementById('settings-area');
        const resultsContainer = document.getElementById('results-container');
        const statusContainer = document.getElementById('status-container');
        const statusText = document.getElementById('status-text');
        const formatSelect = document.getElementById('format-select');
        const scaleSelect = document.getElementById('scale-select');
        const downloadAllBtn = document.getElementById('download-all-btn');
        const pageCountInfo = document.getElementById('page-count-info');
        const messageModal = document.getElementById('message-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        lucide.createIcons();
        modalCloseBtn.addEventListener('click', () => messageModal.classList.add('hidden'));

        function showMessage(title, message) {
            modalTitle.textContent = title;
            modalBody.textContent = message;
            messageModal.classList.remove('hidden');
        }

        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-active'); });
        dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('drag-active'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-active');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'application/pdf') {
                handleFile(files[0]);
            } else {
                showMessage('ãƒ•ã‚¡ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼', 'PDFãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿é¸æŠå¯èƒ½ã§ã™ã€‚');
            }
        });

        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => { if (e.target.files.length > 0) handleFile(e.target.files[0]); });

        [formatSelect, scaleSelect].forEach(input => {
            input.addEventListener('change', () => { if (fileInput.files.length > 0) handleFile(fileInput.files[0]); });
        });

        async function handleFile(file) {
            resultsContainer.innerHTML = '';
            resultsContainer.classList.add('hidden');
            canvasMap.clear();
            downloadAllBtn.disabled = true;

            settingsArea.classList.remove('hidden');
            statusContainer.classList.remove('hidden');
            statusText.textContent = 'PDFã‚’è§£æä¸­...';
            originalFileName = file.name;
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                pdfDocument = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                
                statusText.textContent = `${pdfDocument.numPages} ãƒšãƒ¼ã‚¸ã‚’å¤‰æ›ä¸­...`;
                resultsContainer.classList.remove('hidden');
                pageCountInfo.textContent = `å…¨ ${pdfDocument.numPages} ãƒšãƒ¼ã‚¸`;

                for (let i = 1; i <= pdfDocument.numPages; i++) {
                    await renderPage(pdfDocument, i, originalFileName);
                }

                statusContainer.classList.add('hidden');
                downloadAllBtn.disabled = false;
            } catch (error) {
                console.error(error);
                statusText.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¿è­·ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚';
                downloadAllBtn.disabled = true;
            }
        }

        async function renderPage(pdf, pageNum, fileName) {
            const page = await pdf.getPage(pageNum);
            const scale = parseFloat(scaleSelect.value);
            const viewport = page.getViewport({ scale: scale });

            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            canvas.style.width = '100%';
            canvas.style.height = 'auto';
            canvas.className = 'rounded-lg border border-gray-100';

            const renderContext = { canvasContext: context, viewport: viewport };
            await page.render(renderContext).promise;

            canvasMap.set(pageNum, canvas);

            const card = document.createElement('div');
            card.className = 'main-card p-4 flex flex-col gap-4';
            
            const header = document.createElement('div');
            header.className = 'flex justify-between items-center border-b pb-2';
            header.innerHTML = `<span class="text-xs font-bold text-gray-400">PAGE ${pageNum}</span>`;
            
            const btn = document.createElement('button');
            btn.className = 'text-blue-600 hover:text-blue-800 text-[11px] font-bold flex items-center gap-1';
            btn.innerHTML = `<i data-lucide="download" class="w-3 h-3"></i> ä¿å­˜`;
            btn.onclick = () => {
                const format = formatSelect.value;
                const ext = format === 'image/png' ? 'png' : 'jpg';
                const link = document.createElement('a');
                link.href = canvas.toDataURL(format, 0.9);
                link.download = `${fileName.replace('.pdf', '')}_p${pageNum}.${ext}`;
                link.click();
            };

            header.appendChild(btn);
            card.appendChild(header);
            card.appendChild(canvas);
            resultsContainer.appendChild(card);
            lucide.createIcons();
        }

        downloadAllBtn.addEventListener('click', async () => {
            downloadAllBtn.disabled = true;
            statusContainer.classList.remove('hidden');
            statusText.textContent = 'ZIPã‚’ä½œæˆä¸­...';

            const zip = new JSZip();
            const format = formatSelect.value;
            const ext = format === 'image/png' ? 'png' : 'jpg';

            try {
                const sortedPages = Array.from(canvasMap.keys()).sort((a, b) => a - b);
                for (const pageNum of sortedPages) {
                    const canvas = canvasMap.get(pageNum);
                    const base64Data = canvas.toDataURL(format, 0.9).split(',')[1];
                    zip.file(`${originalFileName.replace('.pdf', '')}_p${pageNum}.${ext}`, base64Data, { base64: true });
                }
                const zipContent = await zip.generateAsync({ type: "blob" });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(zipContent);
                link.download = `${originalFileName.replace('.pdf', '')}_images.zip`;
                link.click();
                
                statusContainer.classList.add('hidden');
                downloadAllBtn.disabled = false;
                showMessage('å®Œäº†', 'ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
            } catch (error) {
                statusContainer.classList.add('hidden');
                downloadAllBtn.disabled = false;
                showMessage('ã‚¨ãƒ©ãƒ¼', 'ZIPä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        });
    </script>
</body>
</html>
